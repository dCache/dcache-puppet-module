# Instructions to configure Storage Arrays (DELL Powervault MD3260, MD3460) for dcache.

# =============================================================================
# WARNING: The instructions below might potentially cause large data loss !!!
# =============================================================================


# Check if the storage array is visible on both hosts by running:
lsscsi

# =============================================================================
# The following commands are run only on the FIRST host! E.g. dcache-desy14
# =============================================================================

# Launch the Management GUI and make sure the storage array is detected
SMclient

# Test connection to storage array and check its profile
SMcli localhost -c "show storageArray profile;" | less

# The current configuration can be saved by running:
SMcli localhost -c 'save storageArray configuration file="/root/array-backup.cfg" allConfig;'

# Generate the dcache configuration of the Virtual Disks/LUNs using the appropriate template (replace XXX appropriately):
./dcache-array-gencfg.py $(facter array_host1) $(facter array_host2) dcache-template-dell-XXX.cfg > /root/array.cfg

# Load the newly generated configuration (*)
SMcli localhost -f /root/array.cfg


# =============================================================================
# Run the following commands on BOTH hosts! E.g. dcache-desy14, dcache-desy15
# =============================================================================

# Both hosts need to be rebooted after finishing the storage array configuration
reboot

# Finalize configuration by running the following script on both hosts:
./dcache-array-setup.sh

# And again... reboot both hosts :(
reboot



# (*) In some cases you might need to clear the current configuration before loading the new configuration
# This can be done as follows (WARNING: THIS ERASES ALL DATA ON THE STORAGE ARRAY !!):
echo "clear storageArray configuration;" > /tmp/clear-array.cfg
SMcli localhost -f /tmp/clear-array.cfg
# The previous cmd takes a long time and fails "Error 1012 ... time-out". This behaviour is expected ?!...
# You need to reboot BOTH hosts after clearing the configuration:
reboot
# After rebooting call:
SMclient
# Rename back the storage array, e.g. dcache-desy14-15-array
# Then follow the instructions to clear the "Needs Attention" warning:
# go to Health->Monitoring->Clear Recovery Mode
# Confirm by entering the requested text
