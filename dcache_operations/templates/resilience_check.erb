#! /bin/bash 
<% @pgroup.each do |pgroup| -%>

PGROUP="<%= pgroup %>"
WEBHOST="<%= @webadmin_host %>"
DBHOST="<%= @db_host %>"
DBUSER="<%= @postgres_user %>"

POOLS=`curl -s http://${WEBHOST}:2288/info/poolgroups/${PGROUP}/pools?format=json | grep dcache | sed s/\ \ \"/\'/ | sed s/\"\:\ \{\}/\'/ | sed 0,/\'/s//\(\'/ | sed -zE "s_(.*)'_\1')_"`

runtime=$(date +%s)
sqlquery=$(psql -h ${DBHOST} -q -t -A -U ${DBUSER} -d chimera -c "select count(inumber) from t_locationinfo where inumber in (select inumber from t_locationinfo where inumber in (select distinct(inumber) from t_locationinfo where ilocation in ${POOLS}) and ilocation in ${POOLS} group by inumber having count(inumber) < 2);")

THISHOST=$(hostname | cut -d "." -f 1)
METRIK="RESILIENCE"
GRAFANASTR="3rdparty.${THISHOST}.${METRIK}-{PGROUP} ${sqlquery} ${runtime}"

curl -m 30 --silent -d "metric=${GRAFANASTR}" http://metrics-ext.desy.de:2033
<% end -%>
